<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Fuzzing_arbitrarily_functions_with_LIEF | H4lo&#39;s blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="John Doe">
    
    

    <meta name="description" content="ç¿»è¯‘åŸæ–‡ï¼šhttps:&#x2F;&#x2F;blahcat.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;fuzzing-arbitrary-functions-in-elf-binaries&#x2F; å‰è¨€æˆ‘å†³å®šå¯¹ LIEF é¡¹ç›®è¿›è¡Œ descent æµ‹è¯•ã€‚å¯æ‰§è¡Œçš„è§£æå™¨ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ç‰©ï¼Œè€Œè®©æˆ‘å¥½å¥‡çš„ï¼ˆå°±åƒå¤§å¤šæ•° Quarkslab é¡¹ç›®ä¸€æ ·ï¼‰æ˜¯ï¼Œå› ä¸ºå®ƒè¿˜æä¾›äº†ç®€å•çš„æ£€æµ‹åŠŸèƒ½ã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒLIEF æ˜“äºä½¿ç”¨ä¸”æœ‰å¥½çš„æ–‡æ¡£æ”¯æŒï¼Œ">
<meta property="og:type" content="article">
<meta property="og:title" content="Fuzzing_arbitrarily_functions_with_LIEF | H4lo&#39;s blog">
<meta property="og:url" content="http://yoursite.com/2020/03/31/Fuzzing-arbitrarily-functions-with-LIEF/index.html">
<meta property="og:site_name" content="H4lo&#39;s blog">
<meta property="og:description" content="ç¿»è¯‘åŸæ–‡ï¼šhttps:&#x2F;&#x2F;blahcat.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;fuzzing-arbitrary-functions-in-elf-binaries&#x2F; å‰è¨€æˆ‘å†³å®šå¯¹ LIEF é¡¹ç›®è¿›è¡Œ descent æµ‹è¯•ã€‚å¯æ‰§è¡Œçš„è§£æå™¨ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ç‰©ï¼Œè€Œè®©æˆ‘å¥½å¥‡çš„ï¼ˆå°±åƒå¤§å¤šæ•° Quarkslab é¡¹ç›®ä¸€æ ·ï¼‰æ˜¯ï¼Œå› ä¸ºå®ƒè¿˜æä¾›äº†ç®€å•çš„æ£€æµ‹åŠŸèƒ½ã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒLIEF æ˜“äºä½¿ç”¨ä¸”æœ‰å¥½çš„æ–‡æ¡£æ”¯æŒï¼Œ">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://static.zybuluo.com/H4l0/b1qsyt5g07gmvm0u4yu2en3g/image.png">
<meta property="article:published_time" content="2020-03-31T05:57:43.000Z">
<meta property="article:modified_time" content="2020-03-31T05:58:12.430Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="fuzzing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://static.zybuluo.com/H4l0/b1qsyt5g07gmvm0u4yu2en3g/image.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    
<link rel="stylesheet" href="/css/uno.css">

    
<link rel="stylesheet" href="/css/highlight.css">

    
<link rel="stylesheet" href="/css/archive.css">

    
<link rel="stylesheet" href="/css/china-social-icon.css">


<meta name="generator" content="Hexo 4.2.0"></head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">H4lo&#39;s blog</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          IOT å®‰å…¨ç ”ç©¶çˆ±å¥½è€…
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">é¦–é¡µ</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">å…³äº</a></li>
              
                
                <li class="navigation__item"><a href="/my-archive" title="" class="">å½’æ¡£</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



<nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
      <!-- Github -->
      <li class="navigation__item">
        <a href="https://github.com/H4lo" target="_blank" rel="noopener" title="Huno on GitHub">
          <i class='icon icon-social-github'></i>
          <span class="label">GitHub</span>
        </a>
      </li>
    

    <!-- China social icon -->
    <!--
    
      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-douban'></i>
          <span class="label">Douban</span>
        </a>
      </li>

      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-weibo'></i>
          <span class="label">Weibo</span>
        </a>
      </li>

    -->



  </ul>
</nav>



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Fuzzing_arbitrarily_functions_with_LIEF</h1>

    

    <div class="post-meta">
      <time datetime="2020-03-31" class="post-meta__date date">2020-03-31</time> 

      <span class="post-meta__tags tags">

          

          
             &#8226; æ ‡ç­¾:
            <font class="tags">
              <a class="tags-link" href="/tags/fuzzing/" rel="tag">fuzzing</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>ç¿»è¯‘åŸæ–‡ï¼š<a href="https://blahcat.github.io/2018/03/11/fuzzing-arbitrary-functions-in-elf-binaries/" target="_blank" rel="noopener">https://blahcat.github.io/2018/03/11/fuzzing-arbitrary-functions-in-elf-binaries/</a></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘å†³å®šå¯¹ LIEF é¡¹ç›®è¿›è¡Œ descent æµ‹è¯•ã€‚å¯æ‰§è¡Œçš„è§£æå™¨<a href="https://github.com/eliben/pyelftools" target="_blank" rel="noopener">ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ç‰©</a>ï¼Œè€Œè®©æˆ‘å¥½å¥‡çš„ï¼ˆå°±åƒå¤§å¤šæ•° Quarkslab é¡¹ç›®ä¸€æ ·ï¼‰æ˜¯ï¼Œå› ä¸ºå®ƒè¿˜æä¾›äº†ç®€å•çš„æ£€æµ‹åŠŸèƒ½ã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒLIEF æ˜“äºä½¿ç”¨ä¸”æœ‰å¥½çš„æ–‡æ¡£æ”¯æŒï¼Œè¿™å·²æˆä¸º Infosec å·¥å…·é›†ä¸­ç½•è§çš„ä¼˜ç‚¹ã€‚</p>
<ul>
<li>é€šè¿‡é˜…è¯»ä¸€äº›æœ‰å…³ LIEF çš„åšå®¢æ–‡ç« ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ª<a href="https://lief-project.github.io/doc/latest/tutorials/08_elf_bin2lib.html" target="_blank" rel="noopener">æ–°åŠŸèƒ½</a>ï¼šè½»æ¾åœ°å‘ ELF å¯¼å‡ºè¡¨æ·»åŠ ä»»æ„å‡½æ•°ã€‚æˆ‘å¼ºçƒˆå»ºè®®æ‚¨ä»”ç»†é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚</li>
</ul>
<p>å½“æˆ‘å®Œæˆé˜…è¯»åï¼Œæˆ‘æ„è¯†åˆ°æ­¤åŠŸèƒ½çš„è®¸å¤šä¸é”™çš„åº”ç”¨åœºæ™¯ä¹‹ä¸€å°±æ˜¯æ¨¡ç³Šæµ‹è¯•ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ AFL å‘¢ï¼Ÿå—¯ï¼ŒAFL æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„ï¼ˆå¾ˆæ£’çš„ï¼‰å·¥å…·ï¼Œä½†æ˜¯å®ƒé€šè¿‡æä¾›ä¸€äº›æœ¬åœ°çš„çªå˜è¾“å…¥æ¥æ¨¡ç³Šæ•´ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™å¯¹äºç²¾ç¡®çš„ç›®æ ‡åŠŸèƒ½æ¨¡ç³Šæœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š</p>
<ol>
<li>æ€§èƒ½ï¼šåœ¨é»˜è®¤æ¨¡å¼ï¼ˆå³éæŒä¹…æ€§ï¼‰ä¸‹ï¼ŒAFL ä¼šç”Ÿæˆå¹¶è¿è¡Œæ•´ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™æ˜¾ç„¶ä¼šå¢åŠ è¿›ç¨‹åˆ›å»º/åˆ é™¤æ—¶é—´ï¼Œä»¥åŠæ‰€æœ‰ä»£ç ï¼Œç„¶åå†è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ï¼›</li>
<li>æ¨¡å—åŒ–ï¼šç”¨å®ƒæ¥æ¨¡ç³Šç½‘ç»œæœåŠ¡è§£ææœºåˆ¶å¹¶ä¸å®¹æ˜“ã€‚æˆ‘çŸ¥é“å·²ç»å­˜åœ¨è§£å†³æ­¤é—®é¢˜çš„å°è¯•ï¼Œä½†æ˜¯æˆ‘å‘ç°å®ƒä»¬å¤ªè¿‡åˆ†æ•´æ´å¹¶ä¸”æ‰©å±•æ€§å¾ˆå·®ã€‚</li>
</ol>
<p>å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬æœ‰ LLVM è‡ªå·±çš„ LibFuzzerï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„åº“ï¼Œéå¸¸é€‚åˆâ€¦â€¦æ¨¡ç³Šåº“ã€‚å¹¸è¿çš„æ˜¯ï¼Œå¹¶éæ‰€æœ‰å†…å®¹éƒ½æ˜¯åº“ï¼ˆsshdï¼Œhttpdï¼‰</p>
<p>è¿™æ­£æ˜¯ LIEF å‘æŒ¥ä½œç”¨çš„åœ°æ–¹â€¦â€¦å¦‚ä½•ä½¿ç”¨ LIEF å°†æˆ‘ä»¬ç›®æ ‡çš„ ELF äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰å‡½æ•°å¯¼å‡ºåˆ°å…±äº«å¯¹è±¡ä¸­ï¼Œç„¶åä½¿ç”¨ LibFuzzer å¯¹å…¶è¿›è¡Œæ¨¡ç³Šå¤„ç†ï¼æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç¼–è¯‘å™¨æ¸…ç†ç¨‹åºæ¥è·Ÿè¸ªæ— æ•ˆçš„å†…å­˜è®¿é—®ï¼ä½†è¿™ç”šè‡³è¡Œå¾—é€šå—ï¼Ÿ</p>
<p>äº‹å®è¯æ˜ï¼Œç¡®å®å¦‚æ­¤ï¼ŒèŠ±äº†å¾ˆå¤šæ—¶é—´ï¼Œå¹¶ä¸”åœ¨æˆåŠŸå°è¯•ç®€å•çš„ PoC ä¹‹åï¼Œæˆ‘æ„è¯†åˆ°è¿™é¡¹æŠ€æœ¯å¾ˆé‡è¦ï¼Œå› æ­¤æˆ‘é€‰æ‹©é€šè¿‡å°è¯•å‘ç°å®é™…æ¼æ´å°†å…¶ä»˜è¯¸å®è·µã€‚</p>
<h2 id="å…·ä½“ç¤ºä¾‹ï¼šæ‰¾åˆ°CVE-2018-6789"><a href="#å…·ä½“ç¤ºä¾‹ï¼šæ‰¾åˆ°CVE-2018-6789" class="headerlink" title="å…·ä½“ç¤ºä¾‹ï¼šæ‰¾åˆ°CVE-2018-6789"></a>å…·ä½“ç¤ºä¾‹ï¼šæ‰¾åˆ°CVE-2018-6789</h2><p>é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼šæœ¬å‘¨æ—©äº›æ—¶å€™ï¼Œ<a href="https://twitter.com/mehqq_" target="_blank" rel="noopener">mehqq</a> å‘å¸ƒäº†<a href="https://devco.re/blog/2018/03/06/exim-off-by-one-RCE-exploiting-CVE-2018-6789-en/" target="_blank" rel="noopener">ä¸€ç¯‡æœ‰å…³ CVE-2018-6789 çš„ç²¾å½©åšå®¢æ–‡ç« </a>ï¼Œè¯¦ç»†ä»‹ç»äº†å¥¹åœ¨ Exim ä¸­å‘ç°çš„ä¸€ä¸ªå•ä¸€æ¼æ´çš„åˆ©ç”¨æ­¥éª¤ã€‚è¯¥é—®é¢˜å·²åœ¨ <a href="https://github.com/Exim/exim/commit/cf3cd306062a08969c41a1cdd32c6855f1abecf1" target="_blank" rel="noopener">cf3cd306062a08969c41a1cdd32c6855f1abecf1</a> ä¸­ä¿®å¤ï¼Œå¹¶å·²æä¾› CVE-2018-6789ã€‚</p>
<p>Exim æ˜¯ä¸€ä¸ª MTAï¼Œä¸€æ—¦ç¼–è¯‘ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å› æ­¤ï¼ŒAFL å‡ ä¹æ²¡æœ‰å¸®åŠ©ï¼ˆç½‘ç»œæœåŠ¡ï¼‰ï¼Œä½†è¿™å¯¹äº LIEF + LibFuzzer æ˜¯ä¸€ä¸ªå®Œç¾çš„å®è·µæ¡ˆä¾‹ã€‚</p>
<p>æˆ‘ä»¬å¿…é¡»å°† Exim ç¼–è¯‘ä¸º PIEï¼ˆé€šå¸¸ä½¿ç”¨ CFLAGS ä¸­çš„ <code>-fPIC</code> å’Œ LDFLAGS ä¸­çš„ <code>-pie</code> è®¾ç½®ï¼‰ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å¼€å¯ <a href="https://blahcat.github.io/2018/03/11/fuzzing-arbitrary-functions-in-elf-binaries/" target="_blank" rel="noopener">address sanitizer</a>ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰å®ƒä»¬ï¼Œå †ä¸­çš„ä¸€æ¬¡æ€§æº¢å‡ºå¯èƒ½ä¸ä¼šå¼•èµ·æ³¨æ„ã€‚</p>
<h2 id="ä½¿ç”¨-ASAN-amp-PIE-æ¥ç¼–è¯‘ç›®æ ‡ç¨‹åº"><a href="#ä½¿ç”¨-ASAN-amp-PIE-æ¥ç¼–è¯‘ç›®æ ‡ç¨‹åº" class="headerlink" title="ä½¿ç”¨ ASAN &amp; PIE æ¥ç¼–è¯‘ç›®æ ‡ç¨‹åº"></a>ä½¿ç”¨ ASAN &amp; PIE æ¥ç¼–è¯‘ç›®æ ‡ç¨‹åº</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># on ubuntu 16.04 lts</span><br><span class="line">$ sudo apt install libdb-dev libperl-dev libsasl2-dev libxt-dev libxaw7-dev</span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;Exim&#x2F;exim.git</span><br><span class="line"># roll back to the last vulnerable version of exim (parent of cf3cd306062a08969c41a1cdd32c6855f1abecf1)</span><br><span class="line">$ cd exim</span><br><span class="line">$ git reset --hard cf3cd306062a08969c41a1cdd32c6855f1abecf1~1</span><br><span class="line">HEAD is now at 38e3d2df Compiler-quietening</span><br><span class="line"># and compile with PIE + ASAN</span><br><span class="line">$ cd src ; cp src&#x2F;EDITME Local&#x2F;Makefile &amp;&amp; cp exim_monitor&#x2F;EDITME Local&#x2F;eximon.conf</span><br><span class="line"># edit Local&#x2F;Makefile to add a few options like an EXIM_USER, etc.</span><br><span class="line">$ FULLECHO&#x3D;&#39;&#39; LFLAGS+&#x3D;&quot;-L&#x2F;usr&#x2F;lib&#x2F;llvm-6.0&#x2F;lib&#x2F;clang&#x2F;6.0.0&#x2F;lib&#x2F;linux&#x2F; -lasan -pie&quot; \</span><br><span class="line">  CFLAGS+&#x3D;&quot;-fPIC -fsanitize&#x3D;address&quot; LDFLAGS+&#x3D;&quot;-lasan -pie -ldl -lm -lcrypt&quot; \</span><br><span class="line">  LIBS+&#x3D;&quot;-lasan -pie&quot; make -e clean all</span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ ASAN æ— æ³•åˆ›å»ºç¼–è¯‘æ‰€éœ€çš„é…ç½®æ–‡ä»¶ã€‚å› æ­¤ï¼Œç¼–è¾‘ <code>$ EXIM/src/scripts/Configure-config.h</code> çš„ shell è„šæœ¬ä»¥é¿å…è¿‡æ—©ç»“æŸï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">diff --git a&#x2F;src&#x2F;scripts&#x2F;Configure-config.h b&#x2F;src&#x2F;scripts&#x2F;Configure-config.h </span><br><span class="line">index 75d366fc..a82a9c6a 100755</span><br><span class="line"></span><br><span class="line">--- a&#x2F;src&#x2F;scripts&#x2F;Configure-config.h</span><br><span class="line"></span><br><span class="line">+++ b&#x2F;src&#x2F;scripts&#x2F;Configure-config.h</span><br><span class="line"></span><br><span class="line">@@ -37,6 +37,8 @@ st&#x3D;&#39;   &#39;</span><br><span class="line"></span><br><span class="line">   &quot;&#x2F;\\\$&#x2F;d;s&#x2F;#.*\$&#x2F;&#x2F;;s&#x2F;^[$st]*\\([A-Z][^:!+$st]*\\)[$st]*&#x3D;[$st]*\\([^$st]*\\)[$st]*\$&#x2F;\\1&#x3D;\\2 export \\1&#x2F;p&quot; \</span><br><span class="line">   &lt; Makefile ; echo &quot;.&#x2F;buildconfig&quot;) | &#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">+echo</span><br><span class="line"></span><br><span class="line">+</span><br><span class="line"></span><br><span class="line"># If buildconfig ends with an error code, it will have output an error</span><br><span class="line"># message. Ensure that a broken config.h gets deleted.</span><br></pre></td></tr></table></figure>


<p>ç¼–è¯‘å°†æ­£å¸¸è¿›è¡Œï¼Œä¸€æ—¦ç¼–è¯‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ pwntools çš„ checksec å¹¶ç¡®ä¿å…¶ <code>PIE</code> å’Œ <code>ASAN</code> å…¼å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$  checksec .&#x2F;build-Linux-x86_64&#x2F;exim</span><br><span class="line">[*] &#39;&#x2F;vagrant&#x2F;labs&#x2F;fuzzing&#x2F;misc&#x2F;exim&#x2F;src&#x2F;build-Linux-x86_64&#x2F;exim&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    ASAN:     Enabled</span><br></pre></td></tr></table></figure>

<h2 id="å¯¼å‡ºç›®æ ‡å‡½æ•°"><a href="#å¯¼å‡ºç›®æ ‡å‡½æ•°" class="headerlink" title="å¯¼å‡ºç›®æ ‡å‡½æ•°"></a>å¯¼å‡ºç›®æ ‡å‡½æ•°</h2><p>ä» write-up ä¸­å¯ä»¥çœ‹å‡ºï¼Œå­˜åœ¨æ¼æ´çš„å‡½æ•°æ˜¯ <code>src/base 64.c</code>ä¸­çš„ <code>b64decode()</code>ï¼Œå…¶åŸå‹ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int b64decode(const uschar *code, uschar **ptr)</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¸æ˜¯é™æ€çš„ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿæ²¡æœ‰è¢« strippedï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ readelf è½»æ¾è§£æå®ƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -a .&#x2F;build-Linux-x86_64&#x2F;exim</span><br><span class="line">  1560: 00000000001835b8    37 FUNC    GLOBAL DEFAULT   14 lss_b64decode</span><br><span class="line">  3382: 00000000000cb0bd  2441 FUNC    GLOBAL DEFAULT   14 b64decode</span><br></pre></td></tr></table></figure>

<p>å› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬è¦åœ¨ PIE åç§»é‡ 0xcb0bd å¤„å¯¼å‡ºå‡½æ•° <code>b64decode</code>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç®€å•è„šæœ¬ä½¿ç”¨ LIEFï¼ˆ&gt; = 0.9ï¼‰å¯¼å‡ºå‡½æ•°ï¼š</p>
<p>æˆ‘ä»¬è¿˜éœ€è¦å¯¼å‡º <code>store_reset_3()</code>ï¼Œç”¨äºé‡Šæ”¾ç»“æ„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;exe2so.py .&#x2F;build-Linux-x86_64&#x2F;exim 0xcb0bd:b64decode 0x220cde:store_reset_3</span><br><span class="line">[+] exporting &#39;b64decode&#39; to 0xcb0bd</span><br><span class="line">[+] exporting &#39;store_reset_3&#39; to 0x220cde</span><br><span class="line">[+] writing shared object as &#39;.&#x2F;exim.so&#39;</span><br><span class="line">[+] done</span><br></pre></td></tr></table></figure>

<h2 id="ç¼–å†™ä¸€ä¸ª-LibFuzzer-åŠ è½½å™¨ä»¥è°ƒç”¨ç›®æ ‡å‡½æ•°"><a href="#ç¼–å†™ä¸€ä¸ª-LibFuzzer-åŠ è½½å™¨ä»¥è°ƒç”¨ç›®æ ‡å‡½æ•°" class="headerlink" title="ç¼–å†™ä¸€ä¸ª LibFuzzer åŠ è½½å™¨ä»¥è°ƒç”¨ç›®æ ‡å‡½æ•°"></a>ç¼–å†™ä¸€ä¸ª LibFuzzer åŠ è½½å™¨ä»¥è°ƒç”¨ç›®æ ‡å‡½æ•°</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåº“çš„å¥æŸ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int LoadLibrary()</span><br><span class="line">&#123;</span><br><span class="line">        h &#x3D; dlopen(&quot;.&#x2F;exim.so&quot;, RTLD_LAZY);</span><br><span class="line">        return h !&#x3D; NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å¹¶æ ¹æ®å…¶åŸå‹é‡æ„å‡½æ•° <code>b64decode()Â·</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef int(*b64decode_t)(const char*, char**);</span><br><span class="line">[...]</span><br><span class="line">        b64decode_t b64decode &#x3D; (b64decode_t)dlsym(h, &quot;b64decode&quot;);</span><br><span class="line">        printf(&quot;b64decode&#x3D;%p\n&quot;, b64decode);</span><br><span class="line">        int res &#x3D; b64decode(code, &amp;ptr);</span><br><span class="line">        printf(&quot;b64decode() returned %d, result -&gt; &#39;%s&#39;\n&quot;, res, ptr);</span><br><span class="line">        free(ptr-0x10); &#x2F;&#x2F; required to avoid LSan alert (memleak)</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å¯ä»¥è°ƒç”¨ <code>b64decode()</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ clang-6.0 -O1 -g  loader.cpp -no-pie -o runner -ldl</span><br><span class="line">$ echo -n hello world | base64 aGVsbG8gd29ybGQ&#x3D;</span><br><span class="line">$ LD_PRELOAD&#x3D;&#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libasan.so.4.0.0 .&#x2F;runner aGVsbG8gd29ybGQ&#x3D;</span><br><span class="line">b64decode&#x3D;0x7f06885d50bd</span><br><span class="line">b64decode() returned 11, result -&gt; &#39;hello world&#39;</span><br></pre></td></tr></table></figure>


<p>è¿™æ ·å¯è¡Œï¼é€šè¿‡å°†ä»»æ„å‡½æ•°çš„å·¥å…·è®¾ç½®ä¸ºå­æ¸¸æˆï¼Œæˆ‘ä»¬åªèƒ½ä¸ºæ­¤æ„Ÿè°¢ LIEFã€‚</p>
<h2 id="å¼€å§‹-Fuzzing"><a href="#å¼€å§‹-Fuzzing" class="headerlink" title="å¼€å§‹ Fuzzing"></a>å¼€å§‹ Fuzzing</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤æ¡†æ¶å›´ç»•æ­¤æ„å»ºåŸºäº LibFuzzer çš„æ¨¡ç³Šå™¨ï¼š</p>
<p>ç¼–è¯‘ï¼Œè¿è¡Œå®ƒï¼Œå¹¶æƒŠå¹ğŸ˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ clang-6.0 -DUSE_LIBFUZZER -O1 -g -fsanitize&#x3D;fuzzer loader.cpp -no-pie -o fuzzer -ldl</span><br><span class="line">$ LD_PRELOAD&#x3D;&#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libasan.so.4.0.0 .&#x2F;fuzzer</span><br><span class="line">INFO: Loaded 1 modules   (11 inline 8-bit counters): 11 [0x67d020, 0x67d02b),</span><br><span class="line">INFO: Loaded 1 PC tables (11 PCs): 11 [0x46c250,0x46c300),</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#2      INITED cov: 3 ft: 3 corp: 1&#x2F;1b exec&#x2F;s: 0 rss: 42Mb</span><br><span class="line">#11     NEW    cov: 4 ft: 4 corp: 2&#x2F;3b exec&#x2F;s: 0 rss: 43Mb L: 2&#x2F;2 MS: 4 ShuffleBytes-ChangeBit-InsertByte-ChangeBinInt-</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨ <code>b64decode</code> å‡½æ•°ä¸Šæ‰§è¡Œäº†æ¯ç§’è¶…è¿‡ 100 ä¸‡æ¬¡æ‰§è¡Œ/ç§’/å†…æ ¸ï¼Œè¿™ä¸é”™å§ï¼Ÿ</p>
<p>åœ¨ä¸åˆ°1ç§’çš„æ—¶é—´å†…ï¼Œæˆ‘ä»¬å¾—åˆ°äº† @<a href="https://twitter.com/@mehqq_" target="_blank" rel="noopener">mehqq_</a>ï¼ˆCVE-2018-6789ï¼‰å‘ç°çš„å †æº¢å‡ºï¼š</p>
<p><img src="http://static.zybuluo.com/H4l0/b1qsyt5g07gmvm0u4yu2en3g/image.png" alt="image.png-341.6kB"></p>
<blockquote>
<p>æ³¨æ„ï¼šæœ¬å‘¨æ—©äº›æ—¶å€™ï¼Œmehqq_ é€šçŸ¥æˆ‘ï¼Œè¿™æ˜¯ OOB è¯»å–çš„é”™è¯¯ã€‚æˆ‘å°†å°½å¿«å‘å¸ƒæ›´æ–°ï¼Œä»¥æ˜¾ç¤ºå®é™…çš„é”™è¯¯ã€‚æˆ‘å¯¹æ··ä¹±å¾ˆä¸å¥½ã€‚</p>
</blockquote>
<h2 id="æœ€åçš„å·¥ä½œ"><a href="#æœ€åçš„å·¥ä½œ" class="headerlink" title="æœ€åçš„å·¥ä½œ"></a>æœ€åçš„å·¥ä½œ</h2><p>å°½ç®¡æ­¤æŠ€æœ¯ä¸åƒ <code>AFL</code> é‚£æ ·ç‚¹å‡»å³æ’­æ”¾ï¼Œå› ä¸ºå®ƒéœ€è¦æ›´å¤šçš„å·¥ä½œï¼Œä½†å®ƒæä¾›äº†ä¸å¯å¿½è§†çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å‡ºè‰²çš„å¯é æ€§ï¼Œæ˜“äº fuzzing ç½‘ç»œæœåŠ¡ â†’ ç€é‡äºè§£æåŠŸèƒ½ï¼ˆæ— ç½‘ç»œå †æ ˆå¯å¤„ç†ç­‰ï¼‰ã€‚éå¸¸é€‚åˆå¯ä»¥ä¸“æ³¨äºç‰¹å®šç‚¹ï¼ˆæ•°æ®åŒ…è§£æï¼Œæ¶ˆæ¯å¤„ç†ç­‰ï¼‰</li>
<li>ä¼˜ç§€çš„è¡¨ç°ï¼šæ— éœ€ç”Ÿæˆæ•´ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>å®é™…ä¸Šä¸éœ€è¦æºä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é»‘ç›’äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä½¿ç”¨ LibFuzzer</li>
<li>è¾ƒä½çš„ç¡¬ä»¶è¦æ±‚ç”šè‡³åœ¨ç¡¬ä»¶è¾ƒå¼±çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä»¥å¾ˆé«˜çš„é€Ÿç‡è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼ˆå¹¶å°†æ‚¨çš„ RaspberryPis è½¬æ¢ä¸ºæ¨¡ç³Šæµ‹è¯•ç¾¤é›†ğŸ˜ï¼‰</li>
</ul>
<p>ä½†æ˜¯ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯å®Œç¾çš„ï¼Œæ˜¾ç„¶ä¹Ÿæœ‰ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦ç¼–å†™å‡ ä¹æ¯ä¸ªæ¨¡ç³Šå™¨çš„ä»£ç ï¼ˆå› æ­¤ä»…é€‚ç”¨äº C/C++ ç¼–ç äººå‘˜ï¼‰</li>
<li>æ‚¨å¯èƒ½éœ€è¦è€ƒè™‘çš„ç‰¹æ®Šæƒ…å†µï¼ˆæé˜²å†…å­˜æ³„æ¼ï¼ï¼‰</li>
<li>æˆ‘ä»¬å¿…é¡»ç¡®å®šå‡½æ•°åŸå‹ã€‚å½“æ‰“å¼€æºä»£ç ï¼ˆFOSS é¡¹ç›®ï¼‰æ—¶ï¼Œè¿™å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯é»‘ç›’äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½éœ€è¦å…ˆè¿›è¡Œä¸€äº›åè½¬ã€‚Binary Ninja Commercial License ä¹‹ç±»çš„å·¥å…·ä¹Ÿå¯èƒ½å¯¹è‡ªåŠ¨æ‰§è¡Œæ­¤ä»»åŠ¡æœ‰å¾ˆå¤§å¸®åŠ©ã€‚</li>
</ul>
<p>æ€»è€Œè¨€ä¹‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å·§å¦™çš„æ–¹æ³•ï¼Œå¯é€šè¿‡ 2 ä¸ªå‡ºè‰²çš„å·¥å…·æ¥å®ç°ã€‚æˆ‘å¸Œæœ› LIEF ä¸æ–­å‘å±•ï¼Œä¸ºæˆ‘ä»¬å¸¦æ¥æ›´å¤šç±»ä¼¼çš„ä¸œè¥¿ï¼</p>
<p>æ„Ÿè°¢é˜…è¯»ğŸ˜ï¼</p>

  </section>

  <section class="post-comments">

    <!-- å°†è¯„è®ºç³»ç»Ÿï¼ˆä¾‹å¦‚Disqusã€å¤šè¯´ã€å‹è¨€ã€ç•…è¨€ç­‰ï¼‰æä¾›çš„ä»£ç ç‰‡æ®µç²˜è´´åœ¨è¿™é‡Œ -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | ç”±<a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜<a href="https://github.com/someus/huno" target="_blank" rel="noopener">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/jquery.min.js"></script>
    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
